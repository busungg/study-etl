# 1. 도커 네트워크 구조

컨테이너 내부에서 ifconfig를 입력해 컨테이너의 네트워크 인터페이스에 eth0과 lo 네트워크 인터페이스가 있는 것을 확인했습니다.  
이전에 언급한 바와 같이 도커는 컨테이너에 내부 IP를 순차적으로 할당하며, 이 IP는 컨테이너를 재시작할 때마다 변경될 수 있습니다.  
이 내부 IP는 도커가 설치된 호스트, 즉 내부망에서만 쓸 수 있는 IP이므로 외부와 연결될 필요가 있습니다. 이 과정은 컨테이너를 시작할 때마다 호스트에 veth...라는 네트워크 인터페이스를 생성함으로써 이뤄집니다. 도커는 각 컨테이너에 외부와의 네트워크를 제공하기 위해 컨테이너마다 가상 네트워크 인터페이스를 호스트에 생성하며 이 인터페이스의 이름은 veth로 시작합니다. veth 인터페이스는 사용자가 직접 생성할 필요는 없으며 컨테이너가 생성될 때 도커 엔진이 자동으로 생성합니다.  
도커가 설치된 호스트에서 ifconfig가 ip addr과 같은 명령어로 네트워크 인터페이스를 확인하면 실행 중인 컨테이너 수만큼 veth로 시작하는 인터페이스가 생성된 것을 알 수 있습니다.

veth 인터페이스뿐 아니라 docker0이라는 브리지도 존재하는데 docker0 브리지는 각 veth인터페이스와 바인딩되 호스트의 eth0 인터페이스와 이어주는 역할을 합니다.

# 2. 도커 네트워크 기능

컨테이너를 생성하면 기본적으로 docker0 브리지를 통해 외부와 통신할 수 있는 환경을 사용할 수 있지만 사용자의 선택에 따라 여러 네트워크 드라이버를 쓸 수도 있습니다.  
도커가 자체적으로 제공하는 대표적인 네트워크 드라이버로는 브리지(bridge), 호스트(host), 논(none), 컨테이너(container), 오버레이(overlay)가 있습니다.

먼저 도커에서 기본적으로 쓸 수 있는 네트워크는 무엇이 있는지 확인해 봅시다. docker network ls 명령어로 네트워크 목록을 확인합니다. 도커의 네트워크를 다루는 명령어는 docker network로 시작합니다.

브리지 네트워크는 컨테이너를 생성할 때 자동으로 연결되는 docker0 브리지를 활용하도록 설정돼 있습니다.  
이 네트워크는 172.17.0.x IP 대역을 컨테이너에 순차적으로 할당합니다. docker network inspect 명령어를 이용하면 네트워크의 자세한 정보를 살펴볼 수 있습니다. docker inspect --type network를 사용해도 동일한 출력 결과를 볼 수 있습니다.

### 2.1 브리지 네트워크

브리지 네트워크는 docker0이 아닌 사용자 정의 브리지를 새로 생성해 각 컨테이너에 연결하는 네트워크 구조입니다.  
컨테이너는 연결된 브리지를 통해 외부와 통신할 수 있습니다.

기본적으로 존재하는 docker0을 사용하는 브리지 네트워크가 아닌 새로운 브리지 타입의 네트워크를 생성할 수 있습니다.

```
docker network create --driver bridge mybridge
```

docker run 또는 create 명령어에 --net 옵션의 값을 설정하면 컨테이너가 이 네트워크를 사용하도록 설정할 수 있습니다.

```
docker run -i -t --name mynetwork_container --net mybridge ubuntu:14.04
```

### 2.2 호스트 네트워크

네트워크를 호스트로 설정하면 호스트의 네트워크 환경을 그대로 쓸 수 있습니다. 브리지 드라이버 네트워크와 달리 호스트 드라이버의 네트워크는 별도로 생성할 필요 없이 기존의 host라는 이름의 네트워크를 사용합니다.

컨테이너의 네트워크를 호스트 모드로 설정하면 컨테이너 내부의 애플리케이션을 별도의 포트 포워딩 없이 바로 서비스할 수 있습니다.  
이는 마치 실제 호스트에서 애플리케이션을 외부에 노출하는 것과 같습니다.

### 2.3 논 네트워크

none은 말 그대로 아무런 네트워크를 쓰지 않는 것을 뜻합니다.

### 2.4 컨테이너 네트워크

--net 옵션으로 container를 입력하면 다른 컨테이너의 네트워크 네임스페이스 환경을 공유할 수 있습니다.  
공유되는 속성은 내부 IP, 네트워크 인터페이스의 맥(MAC)주소 등입니다.  
다른 컨테이너의 네트워크 환경을 공유하면 내부 IP를 새로 할당받지 않으며 호스트에 veth로 시작하는 가상 네트워크 인터페이스도 생성되지 않습니다.

### 2.5 브리지 네트워크와 --net-alias

브리지 타입의 네트워크와 run 명령어의 --net-alias 옵션을 함께 쓰면 특정 호스트 이름으로 컨테이너 여러 개에 접근할 수 있습니다.

도커의 DNS는 호스트 이름으로 유동적인 컨테이너를 찾을 때 주로 사용됩니다. 가장 대표적인 예가 --link 옵션인데,  
이는 컨테이너의 IP가 변경되도 별명으로 컨테이너를 찾을 수 있게 DNS에 의해 자동으로 관리됩니다.  
단 이 경우는 디폴트 브리지 네트워크의 컨테이너 DNS라는 점이 다릅니다.

### 2.6 MacVLAN 네트워크

MacVLAN은 호스트의 네트워크 인터페이스 카드를 가상화해 물리 네트워크 환경을 컨테이너에게 동일하게 제공합니다.  
따라서 MacVLAN을 사용하면 컨테이너는 물리 네트워크상에서 가상의 맥(MAC) 주소를 가지며, 해당 네트워크에 연결된 다른 장치와의 통신이 가능해집니다.  
MacVLAN에 연결된 컨테이너는 기본적으로 할당되는 IP 대역인 172.17.X.X 대신 네트워크 장비의 IP를 할당받기 때문입니다.
